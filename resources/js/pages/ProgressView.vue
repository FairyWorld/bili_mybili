<template>
    <div value="w-full flex justify-center	">
        <div class="container  mx-auto justify-center " id="main">
            <div class="m-4">

                <div class="flex justify-between">
                    <h1 class="my-8 text-2xl mt-0">
                        <RouterLink to="/">üå∏</RouterLink> {{ t('progress.title') }} {{ $route.params.id }}
                    </h1>
                    <div class="flex gap-4 my-8 text-2xl mt-0 items-center">
                        <!-- ÁßªÂä®Á´ØÊêúÁ¥¢ÊåâÈíÆ -->
                        <button @click="showMobileSearch = true"
                            class="md:hidden text-2xl hover:text-blue-600 transition-colors"
                            :title="t('progress.searchButtonTitle')">
                            üîç
                        </button>
                        <!-- PCÁ´ØÊêúÁ¥¢ÊåâÈíÆ -->
                        <button @click="openDesktopSearch"
                            class="hidden md:block text-2xl hover:text-blue-600 transition-colors"
                            :title="t('progress.searchButtonTitlePC')">
                            üîç
                        </button>
                        <RouterLink to="/videos" class="hover:text-blue-600 transition-colors">
                            üé¨<span class="hidden md:inline"> {{ t('navigation.videoManagement') }}</span>
                        </RouterLink>
                        <RouterLink to="/horizon" target="_blank" class="hover:text-blue-600 transition-colors">
                            üî≠<span class="hidden md:inline"> {{ t('progress.viewTasks') }}</span>
                        </RouterLink>
                    </div>
                </div>

                <!-- PCÁ´ØÊêúÁ¥¢Ê°Ü -->
                <div v-if="showDesktopSearch" class="hidden md:block mb-4">
                    <div class="relative">
                        <input ref="searchInputRef" v-model="searchQuery" type="text"
                            :placeholder="t('progress.searchPlaceholder')"
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            @keydown.esc="closeSearch" @keydown.enter.prevent="navigateToNextResult" />
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">üîç</span>
                        <button v-if="searchQuery" @click="clearSearch"
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            ‚úï
                        </button>
                    </div>
                    <div v-if="searchQuery && searchResults.length > 0"
                        class="mt-2 text-sm text-gray-600 flex items-center gap-2">
                        <span>{{ t('progress.searchResultsFound', { count: searchResults.length }) }}</span>
                        <span v-if="currentSearchIndex >= 0" class="text-blue-600 font-semibold">
                            ({{ currentSearchIndex + 1 }}/{{ searchResults.length }})
                        </span>
                        <span class="text-xs text-gray-500">{{ t('progress.searchNavigateHint') }}</span>
                    </div>
                    <div v-if="searchQuery && searchResults.length === 0" class="mt-2 text-sm text-red-600">
                        {{ t('progress.searchNoResults') }}
                    </div>
                </div>

                <!-- ÁßªÂä®Á´ØÊêúÁ¥¢Ê°Ü -->
                <div v-if="showMobileSearch" class="md:hidden mb-4">
                    <div class="relative">
                        <input ref="mobileSearchInputRef" v-model="searchQuery" type="text"
                            :placeholder="t('progress.searchPlaceholderMobile')"
                            class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            @keydown.esc="closeSearch" @keydown.enter.prevent="navigateToNextResult" />
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">üîç</span>
                        <button @click="closeSearch"
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            ‚úï
                        </button>
                    </div>
                    <div v-if="searchQuery && searchResults.length > 0"
                        class="mt-2 text-sm text-gray-600 flex items-center gap-2 flex-wrap">
                        <span>{{ t('progress.searchResultsFound', { count: searchResults.length }) }}</span>
                        <span v-if="currentSearchIndex >= 0" class="text-blue-600 font-semibold">
                            ({{ currentSearchIndex + 1 }}/{{ searchResults.length }})
                        </span>
                    </div>
                    <div v-if="searchQuery && searchResults.length === 0" class="mt-2 text-sm text-red-600">
                        {{ t('progress.searchNoResults') }}
                    </div>
                </div>

                <div class="flex flex-col md:flex-row md:justify-between gap-4 md:gap-0">
                    <h2 class="text-xl" :title="t('progress.cacheRateDescription')">{{ t('progress.cacheRate') }} {{
                        progress }}% ({{ stat.downloaded
                        }}/{{ stat.count }})</h2>

                    <div class="flex items-center gap-2">
                        <button @click="showCachedOnly = !showCachedOnly" :class="[
                            'relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2',
                            showCachedOnly ? 'bg-blue-600' : 'bg-gray-200'
                        ]" role="switch" :aria-checked="showCachedOnly">
                            <span :class="[
                                'inline-block h-4 w-4 transform rounded-full bg-white transition-transform',
                                showCachedOnly ? 'translate-x-6' : 'translate-x-1'
                            ]" />
                        </button>
                        <label class="text-sm text-gray-700 cursor-pointer" @click="showCachedOnly = !showCachedOnly">
                            {{ t('progress.showCachedOnly') }}
                        </label>
                    </div>
                </div>



                <div class="my-8 w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                    <div class="bg-blue-600 h-2.5 rounded-full" :style="{ width: progress + '%' }"></div>
                </div>

                <!-- Ê°åÈù¢Á´ØÁ≠õÈÄâÂô® -->
                <div class="hidden md:grid grid-cols-4 w-full my-4">
                    <div class="flex flex-col text-center text-white bg-blue-400 hover:bg-gradient-to-r from-purple-500 to-pink-500  py-4 rounded-l-lg"
                        :class="{ 'bg-gradient-to-r': filter.class == null }" @click="setFilter(null)">
                        <span class="text-2xl" :title="t('progress.allVideosDescription')">{{ t('progress.allVideos')
                        }}</span>
                        <span class="text-xl font-semibold">{{ stat.count }}</span>
                    </div>
                    <div class="flex flex-col text-center text-white bg-blue-400 hover:bg-gradient-to-r from-purple-500 to-pink-500 py-4"
                        :class="{ 'bg-gradient-to-r': filter.class == 'valid' }" @click="setFilter('valid')">
                        <span class="text-2xl" :title="t('progress.validVideosDescription')">{{
                            t('progress.validVideos') }}</span>
                        <span class="text-xl font-semibold">{{ stat.valid }}</span>
                    </div>
                    <div class="flex flex-col text-center text-white bg-blue-400 hover:bg-gradient-to-r from-purple-500 to-pink-500 py-4"
                        :class="{ 'bg-gradient-to-r': filter.class == 'invalid' }" @click="setFilter('invalid')">
                        <span class="text-2xl" :title="t('progress.invalidVideosDescription')">{{
                            t('progress.invalidVideos') }}</span>
                        <span class="text-xl font-semibold">{{ stat.invalid }}</span>
                    </div>
                    <div class="flex flex-col text-center text-white bg-blue-400 hover:bg-gradient-to-r from-purple-500 to-pink-500 py-4 rounded-r-lg"
                        :class="{ 'bg-gradient-to-r': filter.class == 'frozen' }" @click="setFilter('frozen')">
                        <span class="text-2xl" :title="t('progress.frozenVideosDescription')">{{
                            t('progress.frozenVideos') }}</span>
                        <span class="text-xl font-semibold">{{ stat.frozen }}</span>
                    </div>
                </div>

                <!-- ÁßªÂä®Á´ØÁ≠õÈÄâÂô® -->
                <div ref="filterRef" class="md:hidden w-full my-4">
                    <!-- ÂÆåÊï¥Ê®°ÂºèÔºöÂΩìÂâçÈÄâ‰∏≠ÁöÑÁ≠õÈÄâÂô®ÊòæÁ§∫ -->
                    <div class="mb-4 p-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg text-white shadow-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-3 h-3 bg-white rounded-full"></div>
                            <div>
                                <div class="text-lg font-semibold">
                                    {{ getCurrentFilterLabel() }}
                                </div>
                                <div class="text-sm opacity-90">
                                    {{ getCurrentFilterCount() }} ‰∏™ËßÜÈ¢ë
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Á≠õÈÄâÂô®ÈÄâÈ°π - ÂÆåÊï¥Ê®°Âºè -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white rounded-lg p-4 shadow-sm border-2 transition-all"
                            :class="filter.class == null ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'"
                            @click="setFilter(null)">
                            <div class="text-center">
                                <div class="text-2xl mb-1">üì∫</div>
                                <div class="text-sm font-medium text-gray-700">{{ t('progress.allVideos') }}</div>
                                <div class="text-lg font-bold text-gray-900">{{ stat.count }}</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm border-2 transition-all"
                            :class="filter.class == 'valid' ? 'border-green-500 bg-green-50' : 'border-gray-200 hover:border-gray-300'"
                            @click="setFilter('valid')">
                            <div class="text-center">
                                <div class="text-2xl mb-1">‚úÖ</div>
                                <div class="text-sm font-medium text-gray-700">{{ t('progress.validVideos') }}</div>
                                <div class="text-lg font-bold text-gray-900">{{ stat.valid }}</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm border-2 transition-all"
                            :class="filter.class == 'invalid' ? 'border-red-500 bg-red-50' : 'border-gray-200 hover:border-gray-300'"
                            @click="setFilter('invalid')">
                            <div class="text-center">
                                <div class="text-2xl mb-1">‚ùå</div>
                                <div class="text-sm font-medium text-gray-700">{{ t('progress.invalidVideos') }}</div>
                                <div class="text-lg font-bold text-gray-900">{{ stat.invalid }}</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm border-2 transition-all"
                            :class="filter.class == 'frozen' ? 'border-orange-500 bg-orange-50' : 'border-gray-200 hover:border-gray-300'"
                            @click="setFilter('frozen')">
                            <div class="text-center">
                                <div class="text-2xl mb-1">üßä</div>
                                <div class="text-sm font-medium text-gray-700">{{ t('progress.frozenVideos') }}</div>
                                <div class="text-lg font-bold text-gray-900">{{ stat.frozen }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÊúÄÂ∞èÊ®°ÂºèÔºöTabÊ†∑ÂºèÁ≠õÈÄâÂô® - Âõ∫ÂÆöÂú®È°∂ÈÉ® -->
                <div v-if="isScrolled"
                    class="md:hidden bg-white border-b border-gray-300 shadow-md fixed top-0 left-0 right-0 z-50 transition-all duration-300 ease-in-out"
                    :style="{ opacity: showMiniFilter ? 1 : 0, transform: showMiniFilter ? 'translateY(0)' : 'translateY(-10px)' }">
                    <div class="grid grid-cols-4 divide-x divide-gray-300">
                        <button
                            class="flex flex-col items-center justify-center py-3 px-1 transition-all duration-200 relative"
                            :class="filter.class == null ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:text-gray-900 active:bg-gray-50'"
                            @click="setFilter(null)">
                            <span class="text-xl leading-none">üì∫</span>
                            <span v-if="filter.class == null"
                                class="absolute bottom-0 left-0 right-0 h-0.5 bg-blue-600"></span>
                        </button>
                        <button
                            class="flex flex-col items-center justify-center py-3 px-1 transition-all duration-200 relative"
                            :class="filter.class == 'valid' ? 'bg-green-50 text-green-600' : 'text-gray-600 hover:text-gray-900 active:bg-gray-50'"
                            @click="setFilter('valid')">
                            <span class="text-xl leading-none">‚úÖ</span>
                            <span v-if="filter.class == 'valid'"
                                class="absolute bottom-0 left-0 right-0 h-0.5 bg-green-600"></span>
                        </button>
                        <button
                            class="flex flex-col items-center justify-center py-3 px-1 transition-all duration-200 relative"
                            :class="filter.class == 'invalid' ? 'bg-red-50 text-red-600' : 'text-gray-600 hover:text-gray-900 active:bg-gray-50'"
                            @click="setFilter('invalid')">
                            <span class="text-xl leading-none">‚ùå</span>
                            <span v-if="filter.class == 'invalid'"
                                class="absolute bottom-0 left-0 right-0 h-0.5 bg-red-600"></span>
                        </button>
                        <button
                            class="flex flex-col items-center justify-center py-3 px-1 transition-all duration-200 relative"
                            :class="filter.class == 'frozen' ? 'bg-orange-50 text-orange-600' : 'text-gray-600 hover:text-gray-900 active:bg-gray-50'"
                            @click="setFilter('frozen')">
                            <span class="text-xl leading-none">üßä</span>
                            <span v-if="filter.class == 'frozen'"
                                class="absolute bottom-0 left-0 right-0 h-0.5 bg-orange-600"></span>
                        </button>
                    </div>
                </div>

                <virtualList :sortable="false" :draggable="''" class="scroller-container" v-model="groupedDataList"
                    data-key="'id'" :keeps=60 :size=340>
                    <template v-slot:item="{ record, index, dataKey }">
                        <ProgressVideoRow :source="record" :key="index" />
                    </template>
                </virtualList>
            </div>

        </div>
    </div>
</template>
<script lang="ts" setup>
import { computed, ref, onMounted, onUnmounted, watch, nextTick } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import { useI18n } from 'vue-i18n';
import type { Cover } from '../api/cover';
import ProgressVideoRow from '../components/ProgressVideoRow.vue';
// @ts-ignore Áº∫Â∞ëÁ±ªÂûãÂ£∞ÊòéÔºåÊåâË°åÂøΩÁï•Á±ªÂûãÊ£ÄÊü•
import VirtualList from 'vue-virtual-sortable';

const { t } = useI18n();
const route = useRoute();
const router = useRouter();


const videoList = ref<VideoType[]>([])
const progress = ref(0)
const showCachedOnly = ref(false)
const isScrolled = ref(false) // ÊòØÂê¶Â∑≤ÊªöÂä®
const filterRef = ref<HTMLElement>() // Á≠õÈÄâÂô®ÂÖÉÁ¥†ÁöÑÂºïÁî®
const isRestoringScroll = ref(false) // ÊòØÂê¶Ê≠£Âú®ÊÅ¢Â§çÊªöÂä®‰ΩçÁΩÆ
const showMiniFilter = computed(() => !isRestoringScroll.value && isScrolled.value)
const searchQuery = ref('') // ÊêúÁ¥¢ÂÖ≥ÈîÆËØç
const showMobileSearch = ref(false) // ÁßªÂä®Á´ØÊêúÁ¥¢Ê°ÜÊòæÁ§∫Áä∂ÊÄÅ
const showDesktopSearch = ref(false) // PCÁ´ØÊêúÁ¥¢Ê°ÜÊòæÁ§∫Áä∂ÊÄÅ
const searchInputRef = ref<HTMLInputElement>() // PCÁ´ØÊêúÁ¥¢ËæìÂÖ•Ê°ÜÂºïÁî®
const mobileSearchInputRef = ref<HTMLInputElement>() // ÁßªÂä®Á´ØÊêúÁ¥¢ËæìÂÖ•Ê°ÜÂºïÁî®
const currentSearchIndex = ref(-1) // ÂΩìÂâçÊêúÁ¥¢ÁªìÊûúÁ¥¢Âºï

const stat = ref({
    count: 0,
    downloaded: 0,
    invalid: 0,
    valid: 0,
    frozen: 0,
})

const filter = ref<{
    class: null | string
}>({
    class: null
})

interface VideoType {
    id: string
    title: string
    video_downloaded_at: string
    invalid: boolean
    frozen: boolean
    pubtime: number
    fav_time: number
    page: number
    video_downloaded_num: number
    cover_info: Cover | null
}

// ‰ªéURLÂèÇÊï∞ÂàùÂßãÂåñËøáÊª§Âô®Áä∂ÊÄÅ
const initFilterFromUrl = () => {
    const filterParam = route.query.filter as string;
    if (filterParam && ['valid', 'invalid', 'frozen'].includes(filterParam)) {
        filter.value.class = filterParam;
    } else {
        filter.value.class = null;
    }
}

// ËÆæÁΩÆËøáÊª§Âô®Âπ∂Êõ¥Êñ∞URL
const setFilter = (filterValue: string | null) => {
    filter.value.class = filterValue;

    // Êõ¥Êñ∞URLÂèÇÊï∞
    const query = { ...route.query };
    if (filterValue) {
        query.filter = filterValue;
    } else {
        delete query.filter;
    }

    router.replace({ query });
}


// ÊêúÁ¥¢ÁªìÊûú
const searchResults = computed(() => {
    if (!searchQuery.value.trim()) {
        return []
    }
    const query = searchQuery.value.trim().toLowerCase()
    return videoList.value.filter(video =>
        video.title.toLowerCase().includes(query)
    )
})

const dataList = computed(() => {
    let list = videoList.value.filter(i => {
        // Â¶ÇÊûúÂêØÁî®‰∫ÜÂè™ÊòæÁ§∫ÁºìÂ≠òËßÜÈ¢ëÁöÑÈÄâÈ°πÔºåÂàôËøáÊª§ÊéâÊú™ÁºìÂ≠òÁöÑËßÜÈ¢ë
        if (showCachedOnly.value && i.video_downloaded_num === 0) {
            return false
        }

        if (filter.value.class == null) {
            return true
        }

        if (filter.value.class == 'invalid' && i.invalid) {
            return true
        } else if (filter.value.class == 'valid' && !i.invalid) {
            return true
        } else if (filter.value.class == 'frozen' && i.frozen) {
            return true
        }

        return false;
    })

    // Â¶ÇÊûúÊúâÂÖ≥ÈîÆËØçÔºåÂàôËøõ‰∏ÄÊ≠•ËøáÊª§ÊêúÁ¥¢ÁªìÊûú
    if (searchQuery.value.trim()) {
        const query = searchQuery.value.trim().toLowerCase()
        list = list.filter(video =>
            video.title.toLowerCase().includes(query)
        )
    }

    return list
})

// Â∞ÜÊï∞ÊçÆÊåâË°åÂàÜÁªÑÔºåÁî®‰∫éËôöÊãüÂàóË°®
// Ê≥®ÊÑèÔºö‰∏çÂÜçÂõ∫ÂÆöÂàóÊï∞Ôºå‰ΩøÁî®ÂìçÂ∫îÂºè grid Â∏ÉÂ±ÄÔºàgrid-cols-1 md:grid-cols-4Ôºâ
const groupedDataList = computed(() => {
    const list = dataList.value;
    const cols = 4; // Âõ∫ÂÆöÁöÑÂàÜÁªÑÊï∞ÔºåÂÆûÈôÖÊ∏≤ÊüìÁî± CSS grid ÊéßÂà∂
    const grouped = [];

    for (let i = 0; i < list.length; i += cols) {
        grouped.push({
            id: `row-${i}`, // ‰∏∫ÊØèË°åÁîüÊàêÂîØ‰∏ÄID
            videos: list.slice(i, i + cols)
        });
    }

    return grouped;
})

// ÁõëÂê¨Ë∑ØÁî±ÂèòÂåñÔºåÊõ¥Êñ∞ËøáÊª§Âô®Áä∂ÊÄÅ
watch(() => route.query.filter, () => {
    initFilterFromUrl();
}, { immediate: true });

// ‰ΩøÁî® IntersectionObserver ÁõëÊµãÁ≠õÈÄâÂô®ÊòØÂê¶Á¶ªÂºÄÂèØËßÜÂå∫Ôºà‰ªÖÁßªÂä®Á´ØÔºâ
let filterObserver: IntersectionObserver | null = null;
const setupFilterObserver = () => {
    // Ê∏ÖÁêÜÊóßÁöÑ observer
    if (filterObserver) {
        filterObserver.disconnect();
        filterObserver = null;
    }

    // Ê°åÈù¢Á´Ø‰∏çÈúÄË¶ÅÁõëÂê¨
    if (window.innerWidth >= 768) {
        isScrolled.value = false;
        return;
    }

    // Á°Æ‰øùÂÖÉÁ¥†Â≠òÂú®
    if (!filterRef.value) return;

    // ÂàõÂª∫Êñ∞ÁöÑ observer
    filterObserver = new IntersectionObserver((entries) => {
        if (isRestoringScroll.value) return;
        const entry = entries[0];
        // ÂΩìÁ≠õÈÄâÂô®Á¶ªÂºÄËßÜÂè£Êó∂ÔºåÊòæÁ§∫Â∞èÁ≠õÈÄâÂô®
        const newIsScrolled = !entry.isIntersecting;
        if (isScrolled.value !== newIsScrolled) {
            isScrolled.value = newIsScrolled;
        }
    }, {
        root: null,
        threshold: 0,
        rootMargin: '-1px 0px 0px 0px' // Âè™Ë¶ÅÁ≠õÈÄâÂô®È°∂ÈÉ®Á¶ªÂºÄËßÜÂè£Â∞±Ëß¶Âèë
    });

    filterObserver.observe(filterRef.value);
};

onMounted(() => {
    // ÂàùÂßãÂåñËøáÊª§Âô®Áä∂ÊÄÅ
    initFilterFromUrl();
    // ÂàùÂßãÂåñ IntersectionObserver
    setupFilterObserver();
    // ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñÔºåÈáçÊñ∞ËÆæÁΩÆ Observer
    window.addEventListener('resize', setupFilterObserver, { passive: true });
    // Ê∑ªÂä†ÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨ÔºàÊêúÁ¥¢ÂäüËÉΩÔºâ
    document.addEventListener('keydown', handleKeyDown);
    // ÂàùÂßãÂêåÊ≠•‰∏ÄÊ¨°ÔºàÈÅøÂÖçÈ¶ñÊ¨°Èó™ÁÉÅÔºâ
    nextTick(setupFilterObserver);
});

onUnmounted(() => {
    // Êñ≠ÂºÄ Observer
    if (filterObserver) {
        filterObserver.disconnect();
        filterObserver = null;
    }
    // ÁßªÈô§Á™óÂè£Â§ßÂ∞èÂèòÂåñÁõëÂê¨
    window.removeEventListener('resize', setupFilterObserver);
    // ÁßªÈô§ÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨
    document.removeEventListener('keydown', handleKeyDown);
});



// Êï∞ÊçÆÂä†ËΩΩ
fetch(`/api/progress`).then(async (rsp) => {
    if (rsp.ok) {
        const jsonData = await rsp.json()

        videoList.value = jsonData.data
        stat.value = jsonData.stat

        progress.value = parseInt((stat.value.downloaded / stat.value.count * 100).toFixed(2))
    }
})

// Ëé∑ÂèñÂΩìÂâçÁ≠õÈÄâÂô®Ê†áÁ≠æ
const getCurrentFilterLabel = () => {
    switch (filter.value.class) {
        case 'valid':
            return t('progress.validVideos')
        case 'invalid':
            return t('progress.invalidVideos')
        case 'frozen':
            return t('progress.frozenVideos')
        default:
            return t('progress.allVideos')
    }
}

// Ëé∑ÂèñÂΩìÂâçÁ≠õÈÄâÂô®Êï∞Èáè
const getCurrentFilterCount = () => {
    switch (filter.value.class) {
        case 'valid':
            return stat.value.valid
        case 'invalid':
            return stat.value.invalid
        case 'frozen':
            return stat.value.frozen
        default:
            return stat.value.count
    }
}

// ÊêúÁ¥¢Áõ∏ÂÖ≥ÊñπÊ≥ï
const openDesktopSearch = () => {
    if (showDesktopSearch.value) {
        showDesktopSearch.value = false
        // Â¶ÇÊûúÂ∑≤ÁªèÊòæÁ§∫ÔºåÂàôÈöêËóèÂπ∂Ê∏ÖÁ©∫ÊêúÁ¥¢
        // searchQuery.value = ''
        // currentSearchIndex.value = -1
    } else {
        // Â¶ÇÊûúÊ≤°ÊòæÁ§∫ÔºåÂàôÊòæÁ§∫Âπ∂ËÅöÁÑ¶
        showDesktopSearch.value = true
        nextTick(() => {
            searchInputRef.value?.focus()
        })
    }
}

const closeSearch = () => {
    searchQuery.value = ''
    showMobileSearch.value = false
    showDesktopSearch.value = false
    currentSearchIndex.value = -1
}

const clearSearch = () => {
    searchQuery.value = ''
    currentSearchIndex.value = -1
}

// Â§ÑÁêÜCtrl+FÂø´Êç∑ÈîÆ
const handleKeyDown = (e: KeyboardEvent) => {
    // Ctrl+F Êàñ Cmd+F (Mac)
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
        e.preventDefault()
        // ÈòªÊ≠¢ÊµèËßàÂô®ÈªòËÆ§ÊêúÁ¥¢
        if (window.innerWidth >= 768) {
            // PCÁ´ØÔºöÊòæÁ§∫Âπ∂ËÅöÁÑ¶ÊêúÁ¥¢Ê°Ü
            openDesktopSearch()
        } else {
            // ÁßªÂä®Á´ØÔºöÊòæÁ§∫ÊêúÁ¥¢Ê°Ü
            showMobileSearch.value = true
            nextTick(() => {
                mobileSearchInputRef.value?.focus()
            })
        }
        return false
    }

    // F3 ÂØºËà™Âà∞‰∏ã‰∏Ä‰∏™ÁªìÊûúÔºàÂÖ®Â±ÄÂø´Êç∑ÈîÆÔºâ
    if (e.key === 'F3' && !e.shiftKey) {
        if (searchQuery.value.trim() && searchResults.value.length > 0) {
            e.preventDefault()
            navigateToNextResult()
        }
    }

    // Shift+F3 ÂØºËà™Âà∞‰∏ä‰∏Ä‰∏™ÁªìÊûú
    if (e.shiftKey && e.key === 'F3') {
        if (searchQuery.value.trim() && searchResults.value.length > 0) {
            e.preventDefault()
            navigateToPrevResult()
        }
    }
}

// ÂØºËà™Âà∞‰∏ã‰∏Ä‰∏™ÊêúÁ¥¢ÁªìÊûú
const navigateToNextResult = () => {
    if (searchResults.value.length === 0) return

    // Â¶ÇÊûúËøòÊ≤°ÊúâÂºÄÂßãÂØºËà™Ôºå‰ªéÁ¨¨‰∏Ä‰∏™ÁªìÊûúÂºÄÂßã
    if (currentSearchIndex.value < 0) {
        currentSearchIndex.value = 0
    } else {
        currentSearchIndex.value = (currentSearchIndex.value + 1) % searchResults.value.length
    }
    scrollToSearchResult()
}

// ÂØºËà™Âà∞‰∏ä‰∏Ä‰∏™ÊêúÁ¥¢ÁªìÊûú
const navigateToPrevResult = () => {
    if (searchResults.value.length === 0) return

    currentSearchIndex.value = currentSearchIndex.value <= 0
        ? searchResults.value.length - 1
        : currentSearchIndex.value - 1
    scrollToSearchResult()
}

// ÊªöÂä®Âà∞ÊêúÁ¥¢ÁªìÊûú
const scrollToSearchResult = () => {
    if (currentSearchIndex.value < 0 || currentSearchIndex.value >= searchResults.value.length) {
        return
    }

    const targetVideo = searchResults.value[currentSearchIndex.value]
    if (!targetVideo) return

    // Âú® dataList ‰∏≠ÊâæÂà∞ÁõÆÊ†áËßÜÈ¢ëÁöÑÁ¥¢Âºï
    const videoIndex = dataList.value.findIndex(v => v.id === targetVideo.id)
    if (videoIndex === -1) return

    // ËÆ°ÁÆóÁõÆÊ†áËßÜÈ¢ëÊâÄÂú®ÁöÑË°åÔºàÊØèË°å4‰∏™ËßÜÈ¢ëÔºâ
    const targetRow = Math.floor(videoIndex / 4)

    // ‰ΩøÁî® nextTick Á°Æ‰øù DOM Â∑≤Êõ¥Êñ∞ÔºåÂπ∂Á≠âÂæÖËôöÊãüÂàóË°®Ê∏≤Êüì
    nextTick(() => {
        setTimeout(() => {
            // Âú®ËôöÊãüÂàóË°®‰∏≠Êü•ÊâæÂåÖÂê´ÁõÆÊ†áËßÜÈ¢ëÁöÑÂÖÉÁ¥†
            const videoElements = document.querySelectorAll(`[data-video-id="${targetVideo.id}"]`)
            if (videoElements.length > 0) {
                const element = videoElements[0] as HTMLElement
                // ÊªöÂä®Âà∞ÂÖÉÁ¥†
                element.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                })
                // Ê∑ªÂä†È´ò‰∫ÆÊïàÊûú
                element.classList.add('search-highlight')
                setTimeout(() => {
                    element.classList.remove('search-highlight')
                }, 2000)
            } else {
                // Â¶ÇÊûúÂÖÉÁ¥†ËøòÊ≤°Ê∏≤ÊüìÔºåÂ∞ùËØïÊªöÂä®Âà∞ÂØπÂ∫îÁöÑË°å
                const scroller = document.querySelector('.scroller-container') as HTMLElement
                if (scroller) {
                    const rowHeight = 340 // ‰º∞ÁÆóÁöÑË°åÈ´ò
                    scroller.scrollTo({
                        top: targetRow * rowHeight,
                        behavior: 'smooth'
                    })
                    // Âª∂ËøüÂêéÂÜçÂ∞ùËØïÂÆö‰ΩçÂÖ∑‰ΩìÂÖÉÁ¥†
                    setTimeout(() => {
                        const elements = document.querySelectorAll(`[data-video-id="${targetVideo.id}"]`)
                        console.log(elements)
                        if (elements.length > 0) {
                            (elements[0] as HTMLElement).scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            })
                            elements[0].classList.add('search-highlight')
                            setTimeout(() => {
                                elements[0].classList.remove('search-highlight')
                            }, 2000)
                        }
                    }, 300)
                }
            }
        }, 100)
    })
}

// ÁõëÂê¨ÊêúÁ¥¢ÁªìÊûúÂèòÂåñÔºåÈáçÁΩÆÁ¥¢Âºï
watch(searchQuery, () => {
    currentSearchIndex.value = -1
})

// ÁõëÂê¨ÁßªÂä®Á´ØÊêúÁ¥¢Ê°ÜÊòæÁ§∫Áä∂ÊÄÅÔºåËá™Âä®ËÅöÁÑ¶
watch(showMobileSearch, (show) => {
    if (show) {
        nextTick(() => {
            mobileSearchInputRef.value?.focus()
        })
    }
})

// ÁõëÂê¨PCÁ´ØÊêúÁ¥¢Ê°ÜÊòæÁ§∫Áä∂ÊÄÅÔºåËá™Âä®ËÅöÁÑ¶
watch(showDesktopSearch, (show) => {
    if (show) {
        nextTick(() => {
            searchInputRef.value?.focus()
        })
    }
})
</script>

<style scoped>
.scroller-container {
    height: calc(100vh - 200px);
    /* ËßÜÂè£È´òÂ∫¶ÂáèÂéªÈ°∂ÈÉ®ÂÜÖÂÆπÁöÑÈ´òÂ∫¶ */
    min-height: 500px;
    /* ÊúÄÂ∞èÈ´òÂ∫¶‰øùËØÅÂèØÁî®ÊÄß */
    overflow-y: auto;
}

/* ÁßªÂä®Á´ØË∞ÉÊï¥ */
@media (max-width: 768px) {
    .scroller-container {
        height: calc(100vh);
        min-height: 400px;
    }
}

@keyframes searchHighlight {
    0% {
        background-color: rgba(59, 130, 246, 0.3);
        box-shadow: inset 0 0 0 3px #3b82f6;
    }

    50% {
        background-color: rgba(59, 130, 246, 0.5);
        box-shadow: inset 0 0 0 3px #2563eb;
    }

    100% {
        background-color: transparent;
        box-shadow: inset 0 0 0 3px rgba(0, 0, 0, 0);
    }
}
</style>
<style>
.search-highlight {
    position: relative;
    border-radius: 8px;
    background-color: rgba(59, 130, 246, 0.3);
}
</style>